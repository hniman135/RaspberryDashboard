version: '3.8'

services:
  # Main Dashboard Service (All-in-one)
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rpi-dashboard
    restart: unless-stopped
    # Enable hardware access for Raspberry Pi (vcgencmd, temperature, etc.)
    privileged: true
    devices:
      - /dev/vchiq:/dev/vchiq           # VideoCore interface
      - /dev/vcio:/dev/vcio             # VideoCore I/O
      - /dev/video0:/dev/video0         # Camera (optional)
    group_add:
      - video                            # Required for vcgencmd access
    ports:
      - "8080:80"       # Web Dashboard
      - "1883:1883"     # MQTT Broker
    volumes:
      # Mount vcgencmd from host for hardware info
      - /usr/bin/vcgencmd:/usr/bin/vcgencmd:ro
      # Mount host thermal zone for CPU temperature
      - /sys/class/thermal:/sys/class/thermal:ro
      # Mount host CPU info
      - /sys/devices/system/cpu:/sys/devices/system/cpu:ro
      # Mount /proc for system info
      - /proc:/host_proc:ro
      # Mount device tree for model info
      - /sys/firmware/devicetree/base:/sys/firmware/devicetree/base:ro
      # Persist database
      - dashboard_data:/var/www/html/data
      # Persist Mosquitto data
      - mosquitto_data:/var/lib/mosquitto
      - mosquitto_logs:/var/log/mosquitto
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - MQTT_BROKER=127.0.0.1
      - MQTT_PORT=1883
      - MQTT_USER=iot_user
      - MQTT_PASSWORD=iot_password
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - iot_network

  # Alternative: Separate Services Architecture
  # Uncomment below if you want to run services separately

  # mosquitto:
  #   image: eclipse-mosquitto:2
  #   container_name: mqtt-broker
  #   restart: unless-stopped
  #   ports:
  #     - "1883:1883"
  #     - "9001:9001"
  #   volumes:
  #     - ./docker/mosquitto.conf:/mosquitto/config/mosquitto.conf
  #     - mosquitto_data:/mosquitto/data
  #     - mosquitto_logs:/mosquitto/log
  #   networks:
  #     - iot_network

  # web:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.web
  #   container_name: rpi-web
  #   restart: unless-stopped
  #   ports:
  #     - "8080:80"
  #   volumes:
  #     - dashboard_data:/var/www/html/data
  #     - ./local.config:/var/www/html/local.config
  #   environment:
  #     - MQTT_BROKER=mosquitto
  #     - MQTT_PORT=1883
  #   depends_on:
  #     - mosquitto
  #   networks:
  #     - iot_network

networks:
  iot_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  dashboard_data:
    name: rpi_dashboard_data
  mosquitto_data:
    name: rpi_mosquitto_data
  mosquitto_logs:
    name: rpi_mosquitto_logs
